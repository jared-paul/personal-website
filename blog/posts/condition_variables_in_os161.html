<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1" class="jsx-3085369149"/><meta charSet="utf-8" class="jsx-3085369149"/><meta name="Description" content="My Personal Blog" class="jsx-3085369149"/><title class="jsx-3085369149"></title><meta name="next-head-count" content="4"/><link rel="preload" href="/personal-website/_next/static/css/0f63b1889cd5ef8ceb09.css" as="style"/><link rel="stylesheet" href="/personal-website/_next/static/css/0f63b1889cd5ef8ceb09.css" data-n-g=""/><link rel="preload" href="/personal-website/_next/static/css/08deba9422879ca0edf1.css" as="style"/><link rel="stylesheet" href="/personal-website/_next/static/css/08deba9422879ca0edf1.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/personal-website/_next/static/chunks/main-a74cbd0f5fd82cffda39.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/webpack-57651bcf5292fdb0f072.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/framework.8952124311421be7a52f.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/d3071e6a.bbb99a9033920b4fc3df.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/commons.59b7fe2ce8b309da4ff5.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/8dc207aca45eebfde40445ac73b166739b430354.7ba960f79d826d9bb977.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/pages/_app-4d5cdec44000f0fd9508.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/d91e9ae9.cb08a17963d628a50ee6.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/a72c1f178d423e4fb16a4d94e8601faf87c631aa.3c3eb840def88e4452bd.js" as="script"/><link rel="preload" href="/personal-website/_next/static/chunks/pages/blog/posts/condition_variables_in_os161-fc96178cc45463e585c3.js" as="script"/><style id="__jsx-3085369149">@import url("https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap|Roboto:wght@400;700&display=swap");html,body{margin:0;padding:0;font-family:"Roboto",-apple-system,BlinkMacSystemFont,"Segoe UI", Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue", sans-serif;background:#333;color:#fff;font-size:1rem;}h1,h2,h3,h4,h5,h6{font-weight:700;font-family:"Nunito",-apple-system,BlinkMacSystemFont,"Segoe UI", Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue", sans-serif;}a{color:#fff;}blockquote{border-left:10px solid #ccc;padding-left:10px;}</style><style id="__jsx-751568785">nav.jsx-751568785{background:#444;width:auto;padding:1rem 2rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-size:1rem;}nav.jsx-751568785 .right-link.jsx-751568785{margin-right:1rem;-webkit-text-decoration:none;text-decoration:none;}nav.jsx-751568785 .left-link.jsx-751568785{-webkit-text-decoration:none;text-decoration:none;}nav.jsx-751568785 a.jsx-751568785:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><style id="__jsx-3000341097">@import url("https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap|Roboto:wght@400;700&display=swap");html.jsx-3000341097,body.jsx-3000341097{margin:0;padding:0;font-family:"Roboto",-apple-system,BlinkMacSystemFont,"Segoe UI", Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue", sans-serif;background:#333;color:#fff;font-size:1rem;}h1.jsx-3000341097,h2.jsx-3000341097,h3.jsx-3000341097,h4.jsx-3000341097,h5.jsx-3000341097,h6.jsx-3000341097{font-weight:700;font-family:"Nunito",-apple-system,BlinkMacSystemFont,"Segoe UI", Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue", sans-serif;}a.jsx-3000341097{color:#fff;}.posts.jsx-3000341097{margin:2rem auto;padding:0 1rem;}.related-posts.jsx-3000341097{margin:2rem auto;padding:0 1rem;}.related-posts-title.jsx-3000341097{font-size:2rem;font-weight:700;color:white;margin-bottom:2rem;}blockquote.jsx-3000341097{border-left:10px solid #ccc;padding-left:10px;}</style><style id="__jsx-1752250021">.blog-title.jsx-1752250021{font-size:2.25rem;font-weight:700;color:#b19cd9;}.regular-title.jsx-1752250021{font-size:1.9rem;font-weight:700;color:#b19cd9;}.details.jsx-1752250021 span.jsx-1752250021{color:#bdbdbd;margin-right:1rem;}.details.jsx-1752250021{margin-bottom:1rem;}</style><style id="__jsx-963972619">figure.jsx-963972619{width:50% padding:1rem;margin:auto;}figcaption.jsx-963972619{font-style:italic;padding:1rem;text-align:right;}img.jsx-963972619{display:block;margin:auto;}</style><style id="__jsx-4189104464">article.jsx-4189104464{margin-bottom:2.5rem;}</style></head><body><div id="__next"><div class="jsx-3085369149"><main class="jsx-3085369149"><nav class="jsx-751568785"><div class="jsx-751568785"><a class="jsx-751568785 left-link" href="/personal-website"><h2 class="jsx-751568785">Home</h2></a></div><div class="jsx-751568785"><a class="jsx-751568785 right-link" href="/personal-website/blog">Blog</a><a class="jsx-751568785 right-link" href="/personal-website">About</a></div></nav><div class="jsx-3085369149 content"><div><div class="jsx-3000341097"><main class="jsx-3000341097"><div class="container-fluid"><div class="row"><div class="col-2"></div><div class="col-7"><div class="jsx-3000341097 posts"><div class="jsx-1752250021"><h1 class="jsx-1752250021 blog-title">Condition Variables/Monitors in OS161</h1><div class="jsx-1752250021 details"><span class="jsx-1752250021">August 4, 2020</span><span role="img" aria-label="one coffee" class="jsx-1752250021">☕ <!-- -->2 min read</span></div></div><article class="jsx-963972619"><h3>What are condition variables?</h3><p>The definition surrounding condition variables is a little questionable. Technically a condition variable is:</p><blockquote><p>A container of threads that are waiting for a certain condition</p><p>— <cite><a href="https://en.wikipedia.org/wiki/Monitor_(synchronization)" target="_blank">Wikipedia</a></cite></p></blockquote><p>However, many people refer to them as what they should be referred to as <strong>Monitors</strong>. A monitor is:</p><blockquote><p>a synchronization construct that allows threads to have both mutual exclusion and the ability to wait (block) for a certain condition to become false. Monitors also have a mechanism for signaling other threads that their condition has been met. A monitor consists of a mutex (lock) object and <strong>condition variables</strong>.</p><p>— <cite><a href="https://en.wikipedia.org/wiki/Monitor_(synchronization)" target="_blank">Wikipedia</a></cite></p></blockquote><p>All things considered, it doesn&#x27;t matter too much as long as there isn&#x27;t any confusion.</p><h3>Use-case</h3><p>A common use of monitors is a bounded buffer </p><pre><pre class="prism-code language-java" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">lock_acquire</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">itemsFull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">cv_wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">itemsNotFull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  items</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">cv_signal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">itemsNotEmpty</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">lock_release</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">take</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">lock_acquire</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">itemsEmpty</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">cv_wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">itemsNotEmpty</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> items</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">poll</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">cv_signal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">itemsNotFull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">lock_release</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cv_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></pre></pre><p>— Adapted from <cite><a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/Condition.html" target="_blank">Oracle</a></cite></p><h3>Implementation</h3><p>This post assumes you have already implemented locks in OS161. If you haven&#x27;t please check out <a href="#" style="color:#e83e8c">implementing locks in OS161</a></p><p>As above, to implement a monitor we need a lock and the actual condition variable. We already have our lock, but we still need our representation of
a condition variable. To represent a condition variable all we need is a wait channel (wchan). Our condition variable struct only needs to contain
a wait channel and a name. In reality, we don&#x27;t need a name, but our wait channel does so we should just add it.</p><p>There is one more thing we need that is specific to OS161 to implement our monitor: a spinlock. Since we are using a wait channel for our implementation, the wait channel
is not inherently thread-safe. Meaning, we have to guard the wait channel ourselves with a spinlock.</p><p>Note: each condition variable has its own wait channel</p><p><strong><span style="font-size:larger"><code>Create</code></span> :</strong></p><p>We need to create our wait channel, initialize our spinlock, and allocate space for our condition variable.
We don&#x27;t need to handle any synchronization in the creation of our monitor.</p><p><strong><span style="font-size:larger"><code>Destroy</code></span> :</strong></p><p>Destroying is basically just freeing up the memory that we allocated in creation, cleaning up the spinlock, and
destroying the wait channel.</p><p><strong><span style="font-size:larger"><code>Wait</code></span> :</strong></p><p>We want to acquire our wait channels spinlock in order to protect it. From the example use-case above, we should already hold
our monitors lock. Before we sleep on the wait channel we want to release the lock in-order to let someone else use it while we
are sleeping (not doing anything). Once we&#x27;ve released the lock we sleep on the wait channel. When we are woken up we need to release
the wait channel&#x27;s spin lock and reacquire our monitor&#x27;s lock.</p><p><strong><span style="font-size:larger"><code>Signal</code></span> :</strong></p><p>Signal is very easy! All we need to do is wake someone up that is sleeping on the wait channel. Don&#x27;t forget to protect it with its spinlock.</p><p><strong><span style="font-size:larger"><code>Broadcast</code></span> :</strong></p><p>Broadcast is identical to <code>signal(...)</code> with the exception of instead of waking up only one thread, we wake up all threads.</p></article></div></div><div class="col"><div class="jsx-3000341097 related-posts"><h1 class="jsx-3000341097 related-posts-title">Related Posts</h1><article class="jsx-4189104464"><div class="jsx-1752250021"><h1 class="jsx-1752250021 regular-title">Locks in OS161</h1><div class="jsx-1752250021 details"><p class="jsx-1752250021">Getting started and implementing locks in OS161</p><span class="jsx-1752250021">January 4, 2020</span><span role="img" aria-label="one coffee" class="jsx-1752250021">☕ <!-- -->2 min read</span></div></div><a class="jsx-4189104464" href="/personal-website/blog/posts/locks_in_os161">Read more...</a></article></div></div></div></div></main></div></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/posts/condition_variables_in_os161","query":{},"buildId":"nrsiOQGhNFZzMgQ3swdsO","assetPrefix":"/personal-website","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/personal-website/_next/static/chunks/polyfills-a0d5592a936f662dcdbf.js"></script><script src="/personal-website/_next/static/chunks/main-a74cbd0f5fd82cffda39.js" async=""></script><script src="/personal-website/_next/static/chunks/webpack-57651bcf5292fdb0f072.js" async=""></script><script src="/personal-website/_next/static/chunks/framework.8952124311421be7a52f.js" async=""></script><script src="/personal-website/_next/static/chunks/d3071e6a.bbb99a9033920b4fc3df.js" async=""></script><script src="/personal-website/_next/static/chunks/commons.59b7fe2ce8b309da4ff5.js" async=""></script><script src="/personal-website/_next/static/chunks/8dc207aca45eebfde40445ac73b166739b430354.7ba960f79d826d9bb977.js" async=""></script><script src="/personal-website/_next/static/chunks/pages/_app-4d5cdec44000f0fd9508.js" async=""></script><script src="/personal-website/_next/static/chunks/d91e9ae9.cb08a17963d628a50ee6.js" async=""></script><script src="/personal-website/_next/static/chunks/a72c1f178d423e4fb16a4d94e8601faf87c631aa.3c3eb840def88e4452bd.js" async=""></script><script src="/personal-website/_next/static/chunks/pages/blog/posts/condition_variables_in_os161-fc96178cc45463e585c3.js" async=""></script><script src="/personal-website/_next/static/nrsiOQGhNFZzMgQ3swdsO/_buildManifest.js" async=""></script><script src="/personal-website/_next/static/nrsiOQGhNFZzMgQ3swdsO/_ssgManifest.js" async=""></script></body></html>